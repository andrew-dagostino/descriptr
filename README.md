# UoG Course Descriptr.ly

![Pipeline](https://gitlab.socs.uoguelph.ca/cis4250_team3/uog-course-descriptions/badges/develop/pipeline.svg?style=flat-square) ![Coverage](https://gitlab.socs.uoguelph.ca/cis4250_team3/uog-course-descriptions/badges/develop/coverage.svg?style=flat-square)

[[_TOC_]]

## Installation

1. Host file the following:

    ```
    127.0.0.1       dev.cis4250-03.socs.uoguelph.ca
    ```

2. Generate and trust an ssl certificate for the app:

    ```
    $ cd <project_root>
    $ openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \
        -keyout docker/nginx_load_balancer/nginx/ssl/dev.key.pem -out docker/nginx_load_balancer/nginx/ssl/dev.full.pem \
        -subj "/CN=*.cis4250-03.socs.uoguelph.ca" -addext "subjectAltName=DNS:cis4250-03.socs.uoguelph.ca,DNS:*.cis4250-03.socs.uoguelph.ca,IP:10.0.0.1"
    ```

    **IMPORTANT**: Add the file docker/nginx_load_balancer/nginx/ssl/dev.full.pem as a trusted certificate authority in your browser.

    Chrome: Go to the url chrome://settings/certificates > Click "Authorities" > Click "Import" > Select the file > Check all the boxes.

    Firefox: Go to the url about:preferences#privacy > Go down to "Certificates" > Click "View Certificates" > Click "Authorities" > Click "Import" > Select the file

3. Initialize a local docker swarm:

    ```
    $ eval "$(docker-machine env -u)"
    $ sudo docker swarm init
    ```

4. Start up a docker registry:
    ```
    $ sudo docker service create --name registry --mount type=volume,source=registry-data,destination=/var/lib/registry --publish published=6000,target=5000 registry:2
    ```

## Testing

Unit tests can be run with the following command while in the api directory:

```
python3 -m unittest
```

Test coverage can be generated by running the following command while in the root directory:

```
pytest --cov=src/api/classes/ --cov=src/api/functions/ src/api/test/
```

## Running

To run Descriptr.ly (API + WEB + NGINX):

1. Build and push the docker images:

    ```
    $ sudo docker-compose --verbose -f docker-compose-swarm.dev.yml build
    $ sudo docker-compose --verbose -f docker-compose-swarm.dev.yml push
    ```

2. Deploy the swarm:
    ```
    $ sudo docker stack deploy --compose-file=docker-compose-swarm.dev.yml descriptr_stack
    ```

Once running, the WEB server will be live at <https://dev.cis4250-03.socs.uoguelph.ca/> & the api will live at <https://dev.cis4250-03.socs.uoguelph.ca/api>.

3. Redeploy swarm after updates:
    ```
    $ docker stack rm descriptr_stack; docker-compose -f docker-compose-swarm.dev.yml build; docker stack deploy --compose-file=docker-compose-swarm.dev.yml descriptr_stack
    ```

    If the command fails from `failed to create service descriptr_stack_descriptr_api: Error response from daemon: network descriptr_stack_descriptr-network not found`, run it again and it should work.

## Deploying To Production

This is quite a process for the first deployment. Read about it in docs/deployments/production/README.md

## Course Data Structure

### Course

-   **Group:**
    -   `string`
    -   e.g.
        -   `Computing and Information Science`
        -   `Accounting`
-   **Departments:**
    -   `List<string>`
    -   e.g.
        -   `{ School of Computer Science }`
        -   `{ Department of Management }`
        -   `{ Dean's Office, College of Arts }`
-   **Code:**
    -   `string`
    -   e.g.
        -   `CIS`
        -   `ACCT`
-   **Number:**
    -   `string`
    -   e.g.
        -   `"1500"`
        -   `"4250"`
-   **Name:**
    -   `string`
    -   e.g.
        -   `Software Design V`
-   **Semesters Offered:**
    -   `List<SemesterOffered (enum)>`
    -   Enum Keys:
        -   `S` - Summer
        -   `F` - Fall
        -   `W` - Winter
        -   `U` - Undefined
    -   e.g.
        -   `{ S }`
        -   `{ S, F, W }`
        -   `{ U }`
-   **Lecture Hours:**
    -   `float`
    -   e.g.
        -   `3.0`
        -   `5.5`
-   **Lab Hours:**
    -   `float`
    -   e.g.
        -   `6.0`
        -   `10.5`
-   **Credits:**
    -   `float`
    -   e.g.
        -   `0.5`
        -   `0.75`
        -   `1.0`
-   **Description:**
    -   `string`
    -   Usually ~50-100 words.
    -   e.g.
        -   `"This introductory course is designed to..."`
-   **Distance Education: (Offerings)**
    -   `DistanceEducation (enum)`
    -   Enum Keys:
        -   `SUPPLEMENTARY` (in addition to) = `"Also offered through Distance Education format."`
        -   `ONLY` (only DE) = `"Offered through Distance Education format only."`
        -   `NO` (no DE) = If either of the above are not specified.
    -   e.g.
        -   `SUPPLEMENTARY`
        -   `ONLY`
        -   `NO`
-   **Year Parity Restrictions: (Offerings)**
    -   `YearParityRestrictions (enum)`
    -   Enum Keys:
        -   `EVEN_YEARS` = `"Offered in even-numbered years."`
        -   `ODD_YEARS` = `"Offered in odd-numbered years."`
        -   `NONE` = If either of the above are not specified.
    -   e.g.
        -   `EVEN_YEARS`
        -   `ODD_YEARS`
        -   `NONE`
-   **Other (Offerings):**
    -   `string`
    -   Anything not covered under Distance Education or Year Parity Restrictions.
    -   e.g.
        -   `"Last offering - Winter 2021"`
-   **Prerequisites:**
    -   Temporarily: `string`
    -   Future:
        -   `List<Prerequisite>`
        -   A list of `Prerequisite` objects, see below for an explanation.
-   **Corequisites:**
    -   Temporarily: `string`
    -   Future:
        -   TBD
-   **Equates:**
    -   Temporarily: `string`
    -   Future:
        -   TBD
-   **Restrictions:**
    -   Temporarily: `string`
    -   Future:
        -   TBD

### Prerequisite

The `Prerequisite` objects functions in the following way:

`Enum : PrerequisiteState`:

-   `Regular`
-   `Optional`
-   `Any`

`Prerequisite`:

-   `courses: List<Course>` = `Courses` this `Prerequisite` object applies to
-   `prerequisites: List<Prerequisite>` = other `Prerequisite` objects this `Prerequisite` object applies to
-   `state: PrerequisiteState` = one of the above enum states
-   `anyAmount: int` = 0 if `PrerequisiteState` is not `Any`, 1-n if `Any`
-   `other: string` = If the prerequisites listed from the course aren't divisible into individual courses (e.g. `"All Phase 3 courses"`, `"4.00 credits including X-course"`).

`Prerequisite` objects are then stored in a `List<Prerequisite>` on the `Course` that they apply to.

Each `Prerequisite` object would be broken down until all of the `Courses` in them have the same predicate/logical state.

If a prerequisite has the `other` variable filled, the prerequisite will have to be manually verified (unless we store a list of all potential situations (e.g. have a list of all Phase 3 courses, or a value for the student's total credits accumulated)).

#### Example:

If a course had the following prerequisites:

-   A course
-   B course or (2 of C, D, E courses)
-   F course optional

The `List<Prerequisite>` on the `Course` would look like:

-   **1** - Prerequisite(
    &emsp; courses: { A },
    &emsp; prerequisites: { },
    &emsp; state: Regular,
    &emsp; anyAmount: 0)
-   **2** - Prerequisite(
    &emsp; courses: { B },
    &emsp; prerequisites: {
    &emsp; &emsp; **3** - Prerequisite(
    &emsp; &emsp; &emsp; courses: { C, D, E },
    &emsp; &emsp; &emsp; prerequisites: { },
    &emsp; &emsp; &emsp; state: Any,
    &emsp; &emsp; &emsp; anyAmount: 2) },
    &emsp; state: Any,
    &emsp; anyAmount: 1)
-   **4** - Prerequisite(
    &emsp; courses: { F },
    &emsp; prerequisites: { },
    &emsp; state: Optional,
    &emsp; anyAmount: 0)

Where:

-   Prerequisite 1 is just a regular prerequisite where the course(s) (A in this case) are just required like usual, so if you have A the object will collapse into True, otherwise False.
-   Prerequisite 2 is a _compound prerequisite_ where if you have B, that fulfils the "Any 1" requirements and Prerequisite 3 doesn't matter, collapsing the prerequisite into True. However, if not it will look at Prerequisite 3 which is a group of courses (C, D, E). If you have "Any 2" of those courses, then the whole compound prerequisite will collapse into True, but if not Prerequisite 2 and 3 will be False.
-   Prerequisite 4 is an optional prerequisite so it doesn't actually matter for the calculation of prerequisites.

## Using Electron

### Building Electron Executable

1. Edit the variable ENV in the `.env` file

    ```
    ENV=PROD
    ```

    When set to `PROD`, it will use assets from the React `build/` folder.

2. Ensure you have all node packages installed:

    ```
    npm --prefix src/web install  # This may not be required as docker could've already installed packages locally.
    ```

3. Next, type the commands:

    ```
    npm --prefix src/web run build
    ```

    Now that the executable is built, you can run `src/web/dist/descriptrly-0.1.0(.exe or .AppImage)`

### Running Electron Locally for Development:

1. Edit the variable ENV in the `.env` file

    ```
    ENV=DEV
    ```

    When set to `DEV`, the Electron app will use assets from the React server. When set to `PROD`, it will use assets from the React `build/` folder.

    You can optionally set the `DEV_URL` environment variable if you wish to use a React dev server running outside of the Docker Swarm.

2. Ensure you have all node packages installed:

    ```
    npm --prefix src/web install  # This may not be required as docker could've already installed packages locally.
    ```

3. In a second terminal, run the following command to start the Electron app:

    ```
    npm --prefix src/web run electron
    ```
